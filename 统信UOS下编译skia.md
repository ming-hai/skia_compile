# 统信UOS系统中使用LLVM或者gcc编译Skia源码的方法 - 修改日期：2025-05-17 - 操作系统：UOS 20 专业版(1070) 64位版本 - 编译器：LLVM or gcc - 说明1：本文档介绍统信UOS系统中使用LLVM或者gcc编译Skia源码的方法 - 说明2：该编译Skia源码的方法，是为了适配[nim duilib](https://github.com/rhett-lee/nim_duilib)项目使用Skia库，如果用于其他库使用，可能需要修改编译参数 - 说明3：获取skia源码后，需要更新部分源码（更新方法见后续文档），否则编译无法通过。（使用了一个第三方库：expat） - 说明4：操作过程中，假设源码的根目录是`/home/develop`目录，如果使用其他目录，可替换为实际的目录。 ## 一、准备工作1. 安装完成系统后，可用升级系统到最新：    （1）升级系统：`sudo apt update`    （2）升级系统：`sudo apt upgrade -y`   2. 安装依赖的软件```sudo apt install -y gcc g++ gdb make git cmake python3 ninja-build python3 \                    unzip libfontconfig1-dev libgl1-mesa-dev libgles2-mesa-dev libegl1-mesa-dev libvulkan-dev ```安装完成后的各个软件版本信息如下：```cmake 已经是最新版 (3.22.1.1-1)。g++ 已经是最新版 (4:8.3.0-1+sign)。gcc 已经是最新版 (4:8.3.0-1+sign)。gdb 已经是最新版 (8.2.1.1-1+security)。git 已经是最新版 (1:2.20.1.3-2+dde)。libfontconfig1-dev 已经是最新版 (2.13.1.1-2+sign)。make 已经是最新版 (4.2.1.1-1+dde)。ninja-build 已经是最新版 (1.8.2-1)。python3 已经是最新版 (3.7.3.1-deepin1)。unzip 已经是最新版 (6.0.7.2-1+deepin+sign)。libegl1-mesa-dev 已经是最新版 (23.1.2.3-1)。libgl1-mesa-dev 已经是最新版 (23.1.2.3-1)。libgles2-mesa-dev 已经是最新版 (23.1.2.3-1)。```（1）libvulkan-dev 下载失败，未安装成功    （2）系统中的gcc/g++版本太低，不能用于编译skia和nim_duilib，需要手工编译最新版的gcc/g++，详见后续文档    （3）说明：系统提供的开发工具版本比较低，不能满足要求，需要使用源码编译开发工具的最新版，包括gcc/g++、llvm/clang/clang++、gn等。    3. 编译安装最新版本的binutils（因系统自带的版本较低，使用ld/gold链接gcc/g++/llvm/clang/clang++的时候，会遇到错误）      ```#!/bin/bashcd /home/develop; mkdir src                                  #创建源码目录cd /home/develop/src                                         #设置工作目录wget https://ftp.gnu.org/gnu/binutils/binutils-2.43.1.tar.gz #下载源码tar -xzf binutils-2.43.1.tar.gz                              #解压源码cd binutils-2.43.1                                           #进入源码目录./configure --prefix=/home/develop/install/binutils-2.43.1/ --disable-werror --enable-gprofng=no #运行配置脚本  #备注：使用`--enable-gprofng=no`选项是因为gprofng的源码有编译错误。    make                                                         #编译make install                                                 #安装``` 4. 从源码编译安装python3的较新版本（3.13.0），因系统自带的版本(3.7.3)太低，无法编译llvm，所以必须升级    ```#!/bin/bashcd /home/develop/src                                                #设置工作目录wget https://www.python.org/ftp/python/3.13.0/Python-3.13.0.tar.xz  #下载源码tar -xJf Python-3.13.0.tar.xz                                       #解压源码cd Python-3.13.0                                                    #进入源码目录./configure --prefix=/home/develop/install/Python-3.13.0/           #运行配置脚本make                                                                #编译make install                                                        #安装, 会遇到错误，但不影响。```5. 从源码编译安装gcc/g++ 的较新版本（14.2.0），因系统自带的版本太低，必须升级   ```#!/bin/bash# 编译资源需求：4GB内存，磁盘空间：12GBcd /home/develop/src                                            #设置工作目录wget https://ftp.gnu.org/gnu/gcc/gcc-14.2.0/gcc-14.2.0.tar.gz   #下载源码tar -xzf gcc-14.2.0.tar.gz                                      #解压源码cd /home/develop/src/gcc-14.2.0                                 #进入gcc-14.2.0源码目录./contrib/download_prerequisites                                #下载编译时依赖的第三方库#配置（说明：由于UOS自带的ld(v2.31.1)链接gcc/g++时失败，所以使用源码编译安装的最新版ld(v2.43.1)）mkdir -p /home/develop/src/gcc-14.2.0.buildcd /home/develop/src/gcc-14.2.0.buildexport LD="/home/develop/install/binutils-2.43.1/bin/ld"../gcc-14.2.0/configure --prefix=/home/develop/install/gcc-14.2.0 --disable-multilib --enable-ld --enable-bootstrap#注意：运行configure的过程中，如果遇到错误，请留意系统的安全拦截提示，按照安全拦截提示，允许任意程序执行即可。   make -j 12                                                      #编译：多进程编译，编译参数可参考电脑实际有几个核心make install                                     #安装，安装目录为：/home/develop/install/gcc-14.2.0``` 编译安装完成后，设置环境变量，以使新版gcc/g++可用（将下列内容放在/home/develop/source.sh文件中，便于使用:`source /home/develop/source.sh`）：    ```#!/bin/bash# python3 export PATH=/home/develop/install/Python-3.13.0/bin/:$PATH# binutilsexport PATH=/home/develop/install/binutils-2.43.1/bin/:$PATH# gcc/g++ 14.2export PATH=/home/develop/install/gcc-14.2.0/bin/:$PATHexport LD_LIBRARY_PATH=/home/develop/install/gcc-14.2.0/lib64/:$LD_LIBRARY_PATHexport C_INCLUDE_PATH=/home/develop/install/gcc-14.2.0/include/c++/14.2.0/:/home/develop/install/gcc-14.2.0/include/c++/14.2.0/x86_64-pc-linux-gnu/:$C_INCLUDE_PATHexport CPLUS_INCLUDE_PATH=/home/develop/install/gcc-14.2.0/include/c++/14.2.0/:/home/develop/install/gcc-14.2.0/include/c++/14.2.0/x86_64-pc-linux-gnu/:$CPLUS_INCLUDE_PATH```    6. 从源码编译安装llvm/clang/clang++的较新版本（19.1.3），因系统自带的版本太低，必须升级    ```#!/bin/bash#编译资源需求：16GB内存cd /home/develop/src                                                              #设置工作目录wget https://github.com/llvm/llvm-project/archive/refs/tags/llvmorg-19.1.3.tar.gz #下载源码tar -xzf llvmorg-19.1.3.tar.gz                                                    #解压源码source /home/develop/source.sh                                                    #使用gcc/g++最新版#生成编译配置cmake -S ./llvm-project-llvmorg-19.1.3/llvm/ -B ./llvm-project-llvmorg-19.1.3.build \      -G Ninja \      -DLLVM_ENABLE_PROJECTS="clang;lld" \      -DCMAKE_BUILD_TYPE=Release \      -DCMAKE_C_COMPILER=/home/develop/install/gcc-14.2.0/bin/gcc \      -DCMAKE_CXX_COMPILER=/home/develop/install/gcc-14.2.0/bin/g++ \      -DCMAKE_INSTALL_PREFIX=/home/develop/install/LLVM-19.1.3ninja -C ./llvm-project-llvmorg-19.1.3.build                                        #编译源码ninja -C ./llvm-project-llvmorg-19.1.3.build install           #安装，安装目录为:/home/develop/install/LLVM-19.1.3```设置环境变量，以使新版llvm/clang/clang++可用（将下列内容放在/home/develop/source.sh文件中，便于使用:`source /home/develop/source.sh`）：    ```#!/bin/bash# python3 export PATH=/home/develop/install/Python-3.13.0/bin/:$PATH# binutilsexport PATH=/home/develop/install/binutils-2.43.1/bin/:$PATH# gcc/g++ 14.2export PATH=/home/develop/install/gcc-14.2.0/bin/:$PATHexport LD_LIBRARY_PATH=/home/develop/install/gcc-14.2.0/lib64/:$LD_LIBRARY_PATHexport C_INCLUDE_PATH=/home/develop/install/gcc-14.2.0/include/c++/14.2.0/:/home/develop/install/gcc-14.2.0/include/c++/14.2.0/x86_64-pc-linux-gnu/:$C_INCLUDE_PATHexport CPLUS_INCLUDE_PATH=/home/develop/install/gcc-14.2.0/include/c++/14.2.0/:/home/develop/install/gcc-14.2.0/include/c++/14.2.0/x86_64-pc-linux-gnu/:$CPLUS_INCLUDE_PATH# llvm/clang/clang++export PATH=/home/develop/install/LLVM-19.1.3/bin/:$PATHexport LD_LIBRARY_PATH=/home/develop/install/LLVM-19.1.3/lib/:$LD_LIBRARY_PATHexport C_INCLUDE_PATH=/home/develop/install/LLVM-19.1.3/include/:$C_INCLUDE_PATHexport CPLUS_INCLUDE_PATH=/home/develop/install/LLVM-19.1.3/include/:$CPLUS_INCLUDE_PATH```    7. 从源码编译安装gn（没找到系统自带的，所以从源码编译）：    ```#!/bin/bashcd /home/develop/src                            #设置工作目录git clone https://github.com/rhett-lee/gn.git   #下载源码cd /home/develop/src/gn                         #进入源码目录source /home/develop/source.sh                  #使用gcc/g++最新版export CXX=g++; python3 build/gen.py            #生成编译配置ninja -C out                                    #编译源码```    设置环境变量，以使gn可用（将下列内容放在/home/develop/source.sh文件中，便于使用:`source /home/develop/source.sh`）：    ```#!/bin/bash# python3 export PATH=/home/develop/install/Python-3.13.0/bin/:$PATH# binutilsexport PATH=/home/develop/install/binutils-2.43.1/bin/:$PATH# gcc/g++ 14.2export PATH=/home/develop/install/gcc-14.2.0/bin/:$PATHexport LD_LIBRARY_PATH=/home/develop/install/gcc-14.2.0/lib64/:$LD_LIBRARY_PATHexport C_INCLUDE_PATH=/home/develop/install/gcc-14.2.0/include/c++/14.2.0/:/home/develop/install/gcc-14.2.0/include/c++/14.2.0/x86_64-pc-linux-gnu/:$C_INCLUDE_PATHexport CPLUS_INCLUDE_PATH=/home/develop/install/gcc-14.2.0/include/c++/14.2.0/:/home/develop/install/gcc-14.2.0/include/c++/14.2.0/x86_64-pc-linux-gnu/:$CPLUS_INCLUDE_PATH# llvm/clang/clang++export PATH=/home/develop/install/LLVM-19.1.3/bin/:$PATHexport LD_LIBRARY_PATH=/home/develop/install/LLVM-19.1.3/lib/:$LD_LIBRARY_PATHexport C_INCLUDE_PATH=/home/develop/install/LLVM-19.1.3/include/:$C_INCLUDE_PATHexport CPLUS_INCLUDE_PATH=/home/develop/install/LLVM-19.1.3/include/:$CPLUS_INCLUDE_PATH# gnexport PATH=/home/develop/src/gn/out/:$PATH```    ## 二、获取skia源码并更新修改代码1. 获取skia源码：    ```#!/bin/bashmkdir /home/develop  cd /home/developgit clone https://github.com/google/skia.gitgit checkout 22d94029d2ac36dfac8d631fa0d1b467f0ab45a7```2. 下载源码和文档，并更新skia的修改代码：    ```#!/bin/bashcd /home/developgit clone https://github.com/rhett-lee/skia_compilemkdir -p skia_compile/srccd skia_compile/srcunzip ../skia.2025-05-17.src.zipcp -rf ./* /home/develop/skia/``` 更新完成后，可以到skia目录中确认一下是否更新成功```#!/bin/bashcd /home/develop/skia/git status``` ## 三、编译skia（编译器：LLVM）1. 进入skia源码目录：    \> `cd /home/develop/skia`    \> `source /home/develop/source.sh`    2. 编译skia静态库（llvm.x64.Release） - `gn gen out/llvm.x64.release --args="target_cpu=\"x64\" cc=\"clang\" cxx=\"clang++\" is_trivial_abi=false is_official_build=true skia_use_libwebp_encode=false skia_use_libwebp_decode=false skia_use_libpng_encode=false skia_use_libpng_decode=false skia_use_zlib=false skia_use_libjpeg_turbo_encode=false skia_use_libjpeg_turbo_decode=false skia_enable_fontmgr_win_gdi=false skia_use_icu=false skia_use_expat=false skia_use_xps=false skia_enable_pdf=false skia_use_wuffs=false skia_enable_svg=true skia_use_expat=true skia_use_system_expat=false is_debug=false extra_cflags=[\"-DSK_DISABLE_LEGACY_PNG_WRITEBUFFER\"]"`     - `ninja -C out/llvm.x64.release` ## 四、编译skia（编译器：gcc/g++，如果不使用LLVM编译器，也可选择用gcc/g++编译）1. 进入skia源码目录：    \> `cd /home/develop/skia`    \> `source /home/develop/source.sh`    2. 编译skia静态库（gcc.x64.release） - `gn gen out/gcc.x64.release --args="target_cpu=\"x64\" cc=\"gcc\" cxx=\"g++\" is_trivial_abi=false is_official_build=true skia_use_libwebp_encode=false skia_use_libwebp_decode=false skia_use_libpng_encode=false skia_use_libpng_decode=false skia_use_zlib=false skia_use_libjpeg_turbo_encode=false skia_use_libjpeg_turbo_decode=false skia_enable_fontmgr_win_gdi=false skia_use_icu=false skia_use_expat=false skia_use_xps=false skia_enable_pdf=false skia_use_wuffs=false skia_enable_svg=true skia_use_expat=true skia_use_system_expat=false is_debug=false extra_cflags=[\"-DSK_DISABLE_LEGACY_PNG_WRITEBUFFER\"]"`     - `ninja -C out/gcc.x64.release`## 五、资源链接1. Skia的编译文档库，点击访问：[skia compile](https://github.com/rhett-lee/skia_compile) 2. nim duilib的代码库，点击访问：[nim duilib](https://github.com/rhett-lee/nim_duilib) 