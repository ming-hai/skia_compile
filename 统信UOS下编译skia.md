# 统信UOS下编译Skia源码的方法 - 修改日期：2024-09-19 - 操作系统：UOS 20 专业版(1070) 64位版本 - 编译器可选择：LLVM - 操作过程中，源码根目录是/home/develop目录，如果使用其他目录，可替换为实际的目录 - 说明1：该编译Skia源码的方法，是为了适配[nim_duilib](https://github.com/rhett-lee/nim_duilib) 项目使用Skia库，如果用于其他库使用，可能需要修改编译参数 - 说明2：最新的编译方法中，不再使用Skia中依赖的第三方库，所以不再需要运行`python3 tools/git-sync-deps`来获取第三方库的源码## 一、准备工作1.安装g++ 8.3.0 （系统中用sudo apt-get install g++安装，用于编译新版的gcc/g++。gcc/make等不需要安装，系统已经自带）2. 编译安装gcc/g++ 的较新版本（14.2.0），因系统自带的版本太低，必须升级    （1）工作目录：`/home/develop/src`    （2）下载：`https://ftp.gnu.org/gnu/gcc/gcc-14.2.0/gcc-14.2.0.tar.gz`    （3）解压：`tar -xzf gcc-14.2.0.tar.gz`    （4）下载依赖第三方库：进入gcc-14.2.0目录，然后下载依赖的第三方库        `cd /home/develop/src/gcc-14.2.0`        `./contrib/download_prerequisites`    （5）配置：        `mkdir -p /home/develop/src/gcc-14.2.0.build`        `cd /home/develop/src/gcc-14.2.0.build`        `export LD="/usr/bin/gold"; ../gcc-14.2.0/configure --prefix=/home/develop/install/gcc-14.2.0 --disable-multilib --enable-ld --enable-bootstrap`    （6）编译：`make -j 12` 多进程编译，编译参数可参考电脑实际有几个核心。    （7）安装：`make install`    1. 安装python 3.7.3 （系统自带，无需安装）2. 安装git 2.20.1   （系统中用sudo apt-get install git安装）3. 安装cmake 3.22.1 （系统中用sudo apt-get install cmake安装）4. ----------------安装g++ 8.3.0    （系统中用sudo apt-get install g++安装，用于编译新版的gcc/g++）5. 安装ninja 1.8.2  （系统中用sudo apt-get install ninja-build安装）1. 2. 5. 6. 获取skia源码及相关依赖：    （1）建立目录：`/home/develop`    （2）\> `cd /home/develop`    （3）\> `git clone https://github.com/google/skia.git`    （4）备注：skia源码更新的日期：`Date: 2024/9/19 12:01:55`    （5）备注：skia库对应的版本`SHA-1: 2be350ecc20db4e8abe327e2724988b98e2416d4`    （6）更新修改代码：        - 下载需要更新的代码到本地：`git clone https://github.com/rhett-lee/skia_compile`    - 更新文件：解压`Skia.2024-09-19.src.zip`，将解压后的文件，覆盖/home/develop/skia目录中的所有同名文件。    - 注意事项：该修改的代码的SHA-1值，需要比对，如果不是这个版本的代码，直接覆盖可能有问题，需要手工修改；    - 修改代码解决的问题：修改部分其他源码：修复运行时的几个小问题。    ## 二、编译gn.exe（编译skia源码时需要用到gn.exe）1. 下载源码：`https://github.com/rhett-lee/gn.git`    （1）\> `cd /home/develop`    （2）\> `git clone https://github.com/rhett-lee/gn.git`2. 编译gn（注意：vs 2022 已经带了ninja.exe，在安装的时候选择了CMake扩展）:    （1）首先进入vs 2022的命令行编译环境（x64 Native Tools Command Prompt for VS 2022）    （2）进入gn源码目录：`cd /home/develop/gn`    （3）\> `python3 build/gen.py`    （4）\> `ninja -C out`    3. 复制gn.exe文件到skia源码目录    编译完成后，将out\gn.exe 复制到 `/home/develop/skia/bin/` 目录中，编译skia过程中要用到这个gn.exe。## 三、编译skia（编译器：LLVM）### （1）编译64位的Lib（x64版本）1. 首先进入VS 2022的64位命令行编译环境: （x64 Native Tools Command Prompt for VS 2022）2. 进入skia源码目录：    \> `cd /home/develop\skia`3. 编译skia静态库（LLVM.x64.Release） - `.\bin\gn.exe gen out/LLVM.x64.Release --ide="vs2022" --sln="skia" --args="target_cpu=\"x64\" cc=\"clang\" cxx=\"clang++\" clang_win=\"C:/LLVM\" clang_win_version=\"18\" is_trivial_abi=false is_official_build=true skia_use_libwebp_encode=false skia_use_libwebp_decode=false skia_use_libpng_encode=false skia_use_libpng_decode=false skia_use_zlib=false skia_use_libjpeg_turbo_encode=false skia_use_libjpeg_turbo_decode=false skia_enable_fontmgr_win_gdi=false skia_use_icu=false skia_use_expat=false skia_use_xps=false skia_enable_pdf=false skia_use_wuffs=false is_debug=false extra_cflags=[\"-DSK_DISABLE_LEGACY_PNG_WRITEBUFFER\",\"/MT\"]"`     - `ninja -C out/LLVM.x64.Release`4. 编译skia静态库（LLVM.x64.Debug） - `.\bin\gn.exe gen out/LLVM.x64.Debug --ide="vs2022" --sln="skia" --args="target_cpu=\"x64\" cc=\"clang\" cxx=\"clang++\" clang_win=\"C:/LLVM\" clang_win_version=\"18\" is_trivial_abi=false is_official_build=true skia_use_libwebp_encode=false skia_use_libwebp_decode=false skia_use_libpng_encode=false skia_use_libpng_decode=false skia_use_zlib=false skia_use_libjpeg_turbo_encode=false skia_use_libjpeg_turbo_decode=false skia_enable_fontmgr_win_gdi=false skia_use_icu=false skia_use_expat=false skia_use_xps=false skia_enable_pdf=false skia_use_wuffs=false is_debug=false extra_cflags=[\"-DSK_DISABLE_LEGACY_PNG_WRITEBUFFER\",\"/MTd\"]"`     - `ninja -C out/LLVM.x64.Debug`     如果需要重新编译，可用以下命令清理编译的中间文件等文件： - `ninja -C out/LLVM.x64.Debug -t clean` ### （2）编译32位的Lib（x86版本）1. 首先进入VS 2022的32位命令行编译环境: （x86 Native Tools Command Prompt for VS 2022）2. 进入skia源码目录：    \> `cd /home/develop\skia`3. 编译skia静态库（LLVM.x86.Release） - `.\bin\gn.exe gen out/LLVM.x86.Release --ide="vs2022" --sln="skia" --args="target_cpu=\"x86\" cc=\"clang\" cxx=\"clang++\" clang_win=\"C:/LLVM\" clang_win_version=\"18\" is_trivial_abi=false is_official_build=true skia_use_libwebp_encode=false skia_use_libwebp_decode=false skia_use_libpng_encode=false skia_use_libpng_decode=false skia_use_zlib=false skia_use_libjpeg_turbo_encode=false skia_use_libjpeg_turbo_decode=false skia_enable_fontmgr_win_gdi=false skia_use_icu=false skia_use_expat=false skia_use_xps=false skia_enable_pdf=false skia_use_wuffs=false is_debug=false extra_cflags=[\"-DSK_DISABLE_LEGACY_PNG_WRITEBUFFER\",\"/MT\"]"`     - `ninja -C out/LLVM.x86.Release`4. 编译skia静态库（LLVM.x86.Debug） - `.\bin\gn.exe gen out/LLVM.x86.Debug --ide="vs2022" --sln="skia" --args="target_cpu=\"x86\" cc=\"clang\" cxx=\"clang++\" clang_win=\"C:/LLVM\" clang_win_version=\"18\" is_trivial_abi=false is_official_build=true skia_use_libwebp_encode=false skia_use_libwebp_decode=false skia_use_libpng_encode=false skia_use_libpng_decode=false skia_use_zlib=false skia_use_libjpeg_turbo_encode=false skia_use_libjpeg_turbo_decode=false skia_enable_fontmgr_win_gdi=false skia_use_icu=false skia_use_expat=false skia_use_xps=false skia_enable_pdf=false skia_use_wuffs=false is_debug=false extra_cflags=[\"-DSK_DISABLE_LEGACY_PNG_WRITEBUFFER\",\"/MTd\"]"`     - `ninja -C out/LLVM.x86.Debug`## 四、编译skia（编译器：Visual Studio 2022）### （1）编译64位的Lib（x64版本）1. 首先进入vs 2022的64位命令行编译环境:（x64 Native Tools Command Prompt for VS 2022）2. 进入skia源码目录：    \> `cd /home/develop\skia`3. 编译skia静态库（vs2022.x64.Release） - `.\bin\gn.exe gen out/vs2022.x64.Release --ide="vs2022" --sln="skia" --args="target_cpu=\"x64\" is_trivial_abi=false is_official_build=true skia_use_libwebp_encode=false skia_use_libwebp_decode=false skia_use_libpng_encode=false skia_use_libpng_decode=false skia_use_zlib=false skia_use_libjpeg_turbo_encode=false skia_use_libjpeg_turbo_decode=false skia_enable_fontmgr_win_gdi=false skia_use_icu=false skia_use_expat=false skia_use_xps=false skia_enable_pdf=false skia_use_wuffs=false is_debug=false extra_cflags=[\"-DSK_DISABLE_LEGACY_PNG_WRITEBUFFER\",\"/MT\"]"`     - `ninja -C out/vs2022.x64.Release`       4. 编译skia静态库（vs2022.x64.Debug） - `.\bin\gn.exe gen out/vs2022.x64.Debug --ide="vs2022" --sln="skia" --args="target_cpu=\"x64\" is_trivial_abi=false is_official_build=true skia_use_libwebp_encode=false skia_use_libwebp_decode=false skia_use_libpng_encode=false skia_use_libpng_decode=false skia_use_zlib=false skia_use_libjpeg_turbo_encode=false skia_use_libjpeg_turbo_decode=false skia_enable_fontmgr_win_gdi=false skia_use_icu=false skia_use_expat=false skia_use_xps=false skia_enable_pdf=false skia_use_wuffs=false is_debug=false extra_cflags=[\"-DSK_DISABLE_LEGACY_PNG_WRITEBUFFER\",\"/MTd\"]"`     - `ninja -C out/vs2022.x64.Debug`### （2）编译32位的Lib（x86版本）1. 首先进入vs 2022的32位命令行编译环境:（x86 Native Tools Command Prompt for VS 2022）2. 进入skia源码目录：    \> `cd /home/develop\skia`3. 编译skia静态库（vs2022.x86.Release） - `.\bin\gn.exe gen out/vs2022.x86.Release --ide="vs2022" --sln="skia" --args="target_cpu=\"x86\" is_trivial_abi=false is_official_build=true skia_use_libwebp_encode=false skia_use_libwebp_decode=false skia_use_libpng_encode=false skia_use_libpng_decode=false skia_use_zlib=false skia_use_libjpeg_turbo_encode=false skia_use_libjpeg_turbo_decode=false skia_enable_fontmgr_win_gdi=false skia_use_icu=false skia_use_expat=false skia_use_xps=false skia_enable_pdf=false skia_use_wuffs=false is_debug=false extra_cflags=[\"-DSK_DISABLE_LEGACY_PNG_WRITEBUFFER\",\"/MT\"]"`     - `ninja -C out/vs2022.x86.Release`       4. 编译skia静态库（vs2022.x86.Debug） - `.\bin\gn.exe gen out/vs2022.x86.Debug --ide="vs2022" --sln="skia" --args="target_cpu=\"x86\" is_trivial_abi=false is_official_build=true skia_use_libwebp_encode=false skia_use_libwebp_decode=false skia_use_libpng_encode=false skia_use_libpng_decode=false skia_use_zlib=false skia_use_libjpeg_turbo_encode=false skia_use_libjpeg_turbo_decode=false skia_enable_fontmgr_win_gdi=false skia_use_icu=false skia_use_expat=false skia_use_xps=false skia_enable_pdf=false skia_use_wuffs=false is_debug=false extra_cflags=[\"-DSK_DISABLE_LEGACY_PNG_WRITEBUFFER\",\"/MTd\"]"`     - `ninja -C out/vs2022.x86.Debug`   ## 五、为何使用LLVM编译Skia：    因为LLVM编译的代码，执行性能明显比VS好。    用VS编译的代码，运行时有明显卡顿现象，尤其时Debug版。